{% extends 'header.html' %}

{% block head %}
<title>Transfer Test - Gyro Test Tools</title>
<link rel="stylesheet" type="text/css" href="../static/css/dashborad.css">
<script src="{{ url_for('static', filename='js/datatables.js') }}" type="text/javascript"></script>
<script src="{{ url_for('static', filename='js/table-control.js') }}" type="text/javascript"></script>
{% endblock %}

{% block body %}
<div class="row mb-3 d-flex justify-content-between">
    <div class="col-10">
        <h1 class="h4 mb-0 align-bottom">Function Name: {{stk_dict["strFunction"]}}</h1>
    </div>
    <div class="col-2 text-end">
        <button class="btn btn-primary" onclick="location.reload()">Refresh</button>
    </div>
</div>
<div class="row">
    <!-- LOGS TABLE START -->
    <div class="col-10">
        <div class="card">
            <div class="card-header pb-0">
                <div class="row">
                    <h2 class="h3 col-10">Batch</h2>
                    <div class="col-2 text-end">
                        <button type="button" class="btn btn-primary" onclick="cleanup()">
                            Clear Logs
                        </button>
                    </div>
                </div>
            </div>
            <div class="card-body pt-0">
                <table id="table-batch" class="table table-striped table-sm" style="width:100%">
                    <thead>
                        <tr>
                            <th class="col-1">No.</th>
                            <th>Function</th>
                            <th>COMMANDID</th>
                            <th>CARRIERID</th>
                            <th>FROMDEVICE/STKID</th>
                            <th>FROMPORT</th>
                            <th>TODEVICE</th>
                            <th>TOPORT</th>
                            <th>VEHICLEID</th>
                            <th>RESULT</th>
                            <th>Details</th>
                        </tr>
                    </thead>
                    <tbody id="databatch">

                    </tbody>
                </table>
            </div>
        </div>
        <div class="card">
            <div class="card-header pb-0">
                <div class="row">
                    <h2 class="h3 col-10">Logs</h2>
                    <div class="col-2 text-end">
                        <button type="button" class="btn btn-primary" onclick="cleanup()">
                            Clear Logs
                        </button>
                    </div>
                </div>
            </div>
            <div class="card-body pt-0">
                <table id="datatables-reponsive" class="table table-striped table-sm" style="width:100%">
                    <thead>
                        <tr>
                            <th class="col-1">No.</th>
                            <th>Function</th>
                            <th>COMMANDID</th>
                            <th>CARRIERID</th>
                            <th>FROMDEVICE/STKID</th>
                            <th>FROMPORT</th>
                            <th>TODEVICE</th>
                            <th>TOPORT</th>
                            <th>VEHICLEID</th>
                            <th>RESULT</th>
                            <th>Details</th>
                        </tr>
                    </thead>
                    <tbody id="datatables">

                    </tbody>
                </table>
            </div>
        </div>
    </div>
    <!-- LOGS TABLE END -->
    <!-- CONTROL FORM START -->
    <div class="col-2">
        <div class="card">
            <div class="card-body py-3">
                <div class="row">
                    <div class="mb-2">
                        <label class="form-label fw-bolder">Batch Processing:</label>
                        <button id="batch" type="button" class="btn btn-primary w-100 mt-2">Batch</button>
                    </div>
                </div>
            </div>
        </div>
        <div class="card">
            <div class="card-body py-3">
                <div class="row">
                    <div class="mb-2">
                        <label class="form-label fw-bolder">Type Data Processing:</label>
                        <label class="form-label" for="strCARRIERTYPE">strCARRIERTYPE:</label>
                        <input type="text" id="strCARRIERTYPE" name="strCARRIERTYPE" class="form-control"
                            value="MAGAZINE">
                    </div>
                    <div class="mb-2">
                        <label class="form-label" for="strCOMMANDID">strCOMMANDID:</label>
                        <input type="text" id="strCOMMANDID" name="strCOMMANDID" class="form-control" value={{ commandid
                            }}>
                    </div>
                    <div class="mb-2">
                        <label class="form-label" for="strUSERID">strUSERID:</label>
                        <input type="text" id="strUSERID" name="strUSERID" class="form-control"
                            value={{stk_dict["strUSERID"]}}>
                    </div>
                    <div class="mb-2">
                        <label class="form-label" for="strCARRIERID">strCARRIERID:</label>
                        <input type="text" id="strCARRIERRID" name="strCARRIERRID" class="form-control"
                            value="ER-A01-01">
                    </div>
                    <div class="mb-2">
                        <label class="form-label" for="strFROMDEVICE">strFROMDEVICE:</label>
                        <select type="submit" name="strFROMDEVICE" id="strFROMDEVICE_selected" class="form-select">
                            <option value="{{stk_dict['strFROMDEVICE'][0]}}" selected>
                                {{stk_dict["strFROMDEVICE"][0]}}</option>
                            {% for strFROMDEVICE in stk_dict["strFROMDEVICE"][1:] %}
                            <option value="{{strFROMDEVICE}}" id="hope_id">{{strFROMDEVICE}}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-2">
                        <label class="form-label" for="strFROMPORT">strFROMPORT:</label>
                        <select type="submit" name="strFROMPORT" id="strFROMPORT_selected" class="form-select">
                            <option value="{{stk_dict['strFROMPORT'][0]}}" selected>
                                {{stk_dict["strFROMPORT"][0]}}</option>
                            {% for strFROMPORT in stk_dict["strFROMPORT"][1:] %}
                            <option value="{{strFROMPORT}}" id="hope_id">{{strFROMPORT}}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-2">
                        <label class="form-label" for="strTODEVICE">strTODEVICE:</label>
                        <select type="submit" name="strTODEVICE" id="strTODEVICE_selected" class="form-select">
                            <option value="{{stk_dict['strTODEVICE'][0]}}" selected>
                                {{stk_dict["strTODEVICE"][0]}}</option>
                            {% for strTODEVICE in stk_dict["strTODEVICE"][1:] %}
                            <option value="{{strTODEVICE}}" id="hope_id">{{strTODEVICE}}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-2">
                        <label class="form-label" for="strT0PORT">strTOPORT:</label>
                        <input type="text" id="strTOPORT" name="strTOPORT" class="form-control"
                            value={{stk_dict["strTOPORT"]}}>
                    </div>
                    <div class="mb-2">
                        <label class="form-label" for="strEMPTYCARRIER">strEMPTYCARRIER:</label>
                        <input type="text" id="strEMPTYCARRIER" name="strEMPTYCARRIER" class="form-control" value="ON">
                    </div>
                    <div class="mb-2">
                        <label class="form-label" for="strPRIORITY">strPRIORITY:</label>
                        <input type="text" id="strPRIORITY" name="strPRIORITY" class="form-control" value="1">
                    </div>
                    <div class="mb-2">
                        <label class="form-label" for="strCMD">strCMD:</label>
                        <input type="text" id="strCMD" name="strCMD" class="form-control"
                            value={{stk_dict["strFunction"]}}>
                    </div>
                    <div class="mb-2">
                        <label class="form-label" for="strMETHODNAME">strMETHODNAME:</label>
                        <input type="text" id="strMETHODNAME" name="strMETHODNAME" class="form-control"
                            value={{stk_dict["strFunction"]}}>
                    </div>
                    <div class="mb-2">
                        <label class="form-label" for="strFORMNAME">strFORMNAME:</label>
                        <input type="text" id="strFORMNAME" name="strFORMNAME" class="form-control"
                            value={{stk_dict["strFORNAME"]}}>
                    </div>
                    <div class="mb-2">
                        <label for="" form-label>　</label>
                        <button id="send_to_ACS_Getway" type="button"
                            class="btn btn-primary w-100">send_to_ACS_Getway</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- CONTROL FORM END -->
</div>


<script>

    $SCRIPT_ROOT = {{ request.script_root | tojson | safe }};
    idRefresh()
    //console.log("strFROMDEVICE:" + $('#strFROMDEVICE_selected').val());
    //console.log("strFROMPORT:" + $('#strFROMPORT_selected').val());

    $("#strCARRIERRID").val(($('#strFROMDEVICE_selected').val()) + "-" + ($('#strFROMPORT_selected').val()));

    let dataList = JSON.parse(localStorage.getItem('dataLogs_stkmove')) || [];

    updateLogs(dataList)

    function updateLogs(dataList) {
        let datatables = document.querySelector('#datatables')

        let str = ""

        for (let i = 0; i < dataList.length; i++) {
            let data_vehicleid = dataList[i].data._strVEHICLEID ? dataList[i].data._strVEHICLEID : ''
            let data_result = dataList[i].data._strRESULT ? dataList[i].data._strRESULT : ''
            let data_func = dataList[i].data._FUNCTION ? dataList[i].data._FUNCTION : ''
            let data_cmdid = dataList[i].data._strCOMMANDID ? dataList[i].data._strCOMMANDID : ''
            let data_carrierid = dataList[i].data._strCARRIERID ? dataList[i].data._strCARRIERID : ''
            let data_fromdevice = dataList[i].data._strFROMDEVICE ? dataList[i].data._strFROMDEVICE : ''
            let data_fromport = dataList[i].data._strFROMPORT ? dataList[i].data._strFROMPORT : ''
            let data_todevice = dataList[i].data._strTODEVICE ? dataList[i].data._strTODEVICE : ''
            let data_toport = dataList[i].data._strTOPORT ? dataList[i].data._strTOPORT : ''

            str += '<tr> <td>' + dataList[i].no + '</td> <td>' + data_func + '</td> <td>' + data_cmdid + '</td> <td>' + data_carrierid + '</td>  <td>' + data_fromdevice + '</td> <td>' + data_fromport + '</td> <td>' + data_todevice + '</td> <td>' + data_toport + '</td> <td>' + data_vehicleid + '</td>'
            // if( data_result == 'OK' ) {
            // str += '<td class="bg-success">'+ data_result +'</td>'
            // }else if( data_result == 'NG' ){
            //     str += '<td class="bg-danger">'+ data_result +'</td>'
            // }else {
            str += '<td>' + data_result + '</td>'
            // }
            str += '<td> <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#' + data_func + '">Details</button><div class="modal fade" id="' + data_func + '" tabindex="-1" role="dialog" aria-hidden="true"><div class="modal-dialog modal-lg modal-dialog-centered" role="document"><div class="modal-content"><div class="modal-header"><h5 class="modal-title fs-3">Details</h5><button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button></div><div class="modal-body m-3">'
            str += '<table class="table table-striped table-sm"><thead><tr><th scope="col">#</th><th scope="col">Key</th><th scope="col">Result</th></tr></thead><tbody>'
            Object.keys(dataList[i].data).forEach((key, index) => {
                str += '<tr>'
                str += `<td>${index + 1}</td>`
                str += `<td>${key}</td>`
                if (key == '_message_body') {
                    str += `<td><xmp class="text-wrap">${dataList[i].data[key]}</xmp></td>`
                } else {
                    str += `<td>${dataList[i].data[key]}</td>`
                }

                str += '</tr>'
            })
            str += '</tbody></table>'
        }
        datatables.innerHTML = str
    }



    $('#receive_from_MES').click(
        function () {
            console.log("receive message");
            var recv_data = new FormData();
            recv_data.append('strCOMMANDID', $("#strCOMMANDID").val())
            $.ajax({
                type: "POST",
                url: $SCRIPT_ROOT + "/receive_function",
                data: recv_data,
                success: (data) => {
                    //console.log("驗證:" + data.validate);
                    //console.log("價錢:" + data.PayAmount);
                    console.log(data.msmq_label)
                    console.log(data.msmq_message)
                    //var txt2 = $("").text(data.replay);
                    //console.log(txt2)
                    //$("body").append(txt2)
                    //alert(data.validate)
                    //alert(data.Rtnfood)
                    //也可以用jquery來呈現結果
                    //food_name = data.Rtnfood
                    //console.log("食物1:" + food_name)
                },
                contentType: false,
                processData: false,
                dataType: "json"
            });
        }
    );

    $('#batch').click(
        function () {
            console.log("function_batch_in_ajax_script");
            var form_data = new FormData();
            // form_data.append('strCOMMANDID', $("#strCOMMANDID").val());
            // form_data.append('strUSERID', $("#strUSERID").val());
            // form_data.append('strCARRIERRID', $("#strCARRIERRID").val());
            // form_data.append('strCARRIERTYPE', $("#strCARRIERTYPE").val());
            // form_data.append('strFROMDEVICE', $("#strFROMDEVICE_selected").val());
            // form_data.append('strFROMPORT', $("#strFROMPORT_selected").val());
            // form_data.append('strTODEVICE', $("#strTODEVICE_selected").val());
            // form_data.append('strTOPORT', $("#strTOPORT").val());
            // form_data.append('strEMPTYCARRIER', $("#strEMPTYCARRIER").val());
            // form_data.append('strPRIORITY', $("#strPRIORITY").val());
            // form_data.append('strMETHODNAME', $("#strMETHODNAME").val());
            // form_data.append('strFORMNAME', $("#strFORMNAME").val());
            // form_data.append('strCMD', $("#strCMD").val());

            $.ajax({
                type: "POST",
                url: $SCRIPT_ROOT + "/send_batch_function",
                data: form_data,
                success: (data) => {
                    if (data.length > 0) {
                        console.log("大於0")
                        var json_send = [data[0], data[1]];
                    }
                    else {
                        console.log("小於0")
                        var json_send = [data];
                    }

                    for (var i = 0, l = json_send.length; i < l; i++) {
                        for (var key in json_send[i]) {
                            console.log(key + ':' + json_send[i][key]);
                        }
                    }
                    //console.log("驗證:" + data.validate);
                    //console.log("價錢:" + data.PayAmount);
                    // console.log('DATA:', data)

                    // const input = data.send_message_label

                    let dataList = JSON.parse(localStorage.getItem('dataLogs_stkmove')) || [];

                    updateLogs(dataList)

                    function fix_key(key) { return key.replace(/^send_/, '_'); }

                    let test = removeEmptyField(data)

                    function trying(json) {
                        var keys = Object.keys(json);
                        var result = {};

                        for (i = 0; i < keys.length; i++) {
                            var key = keys[i];
                            result[fix_key(key)] = json[key];
                        }
                        return result;
                    }

                    console.log("POSTDATAORI", test)

                    if (test.stkmove_batch_0 != '') {
                        let resendlog = Object.entries(test).slice(0, -1)
                        console.log("BATCHLOG", resendlog)

                        for (let i = 0; i < resendlog.length; i++) {

                            let postdata = {
                                "no": dataList.length + 1,
                                "data": trying(resendlog[i][1])
                            }

                            dataList.push(postdata)
                            console.log(typeof dataList)
                            console.log("BATCH", dataList)
                            localStorage.setItem('dataLogs_stkmove', JSON.stringify(dataList))
                            updateLogs(dataList)
                            postdata = ''
                        }
                    }


                    idRefresh()

                    //console.log(data.length)
                    //console.log(data.send_xml)
                    //var txt2 = $("").text(data.replay);
                    //console.log(txt2)
                    //$("body").append(txt2)
                    //alert(data.validate)
                    //alert(data.Rtnfood)
                    //也可以用jquery來呈現結果
                    //food_name = data.Rtnfood
                    //console.log("食物1:" + food_name)
                },
                contentType: false,
                processData: false,
                dataType: "json",
            });
            function show() {
                var mydate = new Date();

                var mytime = mydate.toLocaleTimeString(); //獲取當前時間
                time = mydate.toLocaleString();//獲取日期與時間
                //console.log("開始時間" + time);
                //console.log("receive message");
                var recv_data = new FormData();
                //recv_data.append('strCOMMANDID', $("#strCOMMANDID").val())
                $.ajax({
                    type: "POST",
                    url: $SCRIPT_ROOT + "/receive_function",
                    data: recv_data,
                    success: (data) => {
                        if (data.length > 0) {
                            //console.log("大於0")
                            var json_recv = [data[0], data[1]];
                        }
                        else {
                            //console.log("小於0")
                            var json_recv = [data];
                        }

                        for (var i = 0, l = json_recv.length; i < l; i++) {
                            for (var key in json_recv[i]) {
                                if (json_recv[i][key] !== "msmq no message") {
                                    if (json_recv[i][key] !== "msmq no label") {
                                        console.log(key + ':' + json_recv[i][key]);
                                    }

                                }

                            }
                        }
                        //console.log("驗證:" + data.validate);
                        //console.log("價錢:" + data.PayAmount);
                        //console.log(data.message_label)

                        // const input = data.recv_message_label
                        // displayData(input)
                        if (data.recv_message_label != 'msmq no label') {
                            let dataList = JSON.parse(localStorage.getItem('dataLogs_stkmove')) || []

                            updateLogs(dataList)

                            let test = removeEmptyField(data)
                            console.log("TESTDATA", test)

                            function fix_key_recv(key) { return key.replace(/^recv_/, '_'); }
                            function fix_key_send(key) { return key.replace(/^send_/, '_'); }

                            function tryingrecv(json) {
                                var keys = Object.keys(json);
                                var result = {};

                                for (i = 0; i < keys.length; i++) {
                                    var key = keys[i];
                                    result[fix_key_recv(key)] = json[key];
                                }
                                return result;
                            }

                            function tryingsend(json) {
                                var keys = Object.keys(json);
                                var result = {};

                                for (i = 0; i < keys.length; i++) {
                                    var key = keys[i];
                                    result[fix_key_send(key)] = json[key];
                                }
                                return result;
                            }
                            console.log("TESTLENGTH", test.length)
                            if (test.length === undefined) {
                                console.log("TESTUNDEFINED", test)
                                let resdata = {
                                    "no": dataList.length + 1,
                                    "data": tryingrecv(test)
                                }
                                // console.log("RESDATA：", resdata)
                                dataList.push(resdata)
                                console.log(typeof dataList)
                                localStorage.setItem('dataLogs_stkmove', JSON.stringify(dataList))
                                updateLogs(dataList)

                                resdata = ''
                            } else if (test.length == 2) {
                                console.log("TEST2", test)
                                let resRecv = test.find(o => o['recv_FUNCTION'])
                                let resSend = test.find(o => o['send_FUNCTION'])
                                let resRecvdata = {
                                    "no": dataList.length + 1,
                                    "data": tryingrecv(resRecv)
                                }
                                dataList.push(resRecvdata)
                                console.log(typeof dataList)
                                localStorage.setItem('dataLogs_stkmove', JSON.stringify(dataList))
                                updateLogs(dataList)
                                resRecvdata = ''

                                let resSenddata = {
                                    "no": dataList.length + 1,
                                    "data": tryingsend(resSend)
                                }
                                dataList.push(resSenddata)
                                console.log(typeof dataList)
                                localStorage.setItem('dataLogs_stkmove', JSON.stringify(dataList))
                                updateLogs(dataList)
                                resSenddata = ''

                            }

                        }

                    },
                    contentType: false,
                    processData: false,
                    dataType: "json"
                });
                //console.log("結束時間" + time);
            }
            setInterval(show, 3000);// 注意函式名沒有引號和括弧！
            // 使用setInterval(“show()”,3000);會報“缺少物件”


        }

    );

    $('#send_to_ACS_Getway').click(

        function () {
            console.log("function is send");
            var form_data = new FormData();
            form_data.append('strCOMMANDID', $("#strCOMMANDID").val());
            form_data.append('strUSERID', $("#strUSERID").val());
            form_data.append('strCARRIERRID', $("#strCARRIERRID").val());
            form_data.append('strCARRIERTYPE', $("#strCARRIERTYPE").val());
            form_data.append('strFROMDEVICE', $("#strFROMDEVICE_selected").val());
            form_data.append('strFROMPORT', $("#strFROMPORT_selected").val());
            form_data.append('strTODEVICE', $("#strTODEVICE_selected").val());
            form_data.append('strTOPORT', $("#strTOPORT").val());
            form_data.append('strEMPTYCARRIER', $("#strEMPTYCARRIER").val());
            form_data.append('strPRIORITY', $("#strPRIORITY").val());
            form_data.append('strMETHODNAME', $("#strMETHODNAME").val());
            form_data.append('strFORMNAME', $("#strFORMNAME").val());
            form_data.append('strCMD', $("#strCMD").val());
            // form_data.append('xxx', $("#xxx").text());
            //附帶text也是可以的
            //var food_name = "";
            //var food_price = "";

            $.ajax({
                type: "POST",
                url: $SCRIPT_ROOT + "/send_function",
                data: form_data,
                success: (data) => {
                    if (data.length > 0) {
                        console.log("大於0")
                        var json_send = [data[0], data[1]];
                    }
                    else {
                        console.log("小於0")
                        var json_send = [data];
                    }

                    for (var i = 0, l = json_send.length; i < l; i++) {
                        for (var key in json_send[i]) {
                            console.log(key + ':' + json_send[i][key]);
                        }
                    }
                    //console.log("驗證:" + data.validate);
                    //console.log("價錢:" + data.PayAmount);
                    // console.log('DATA:', data)

                    // const input = data.send_message_label

                    let dataList = JSON.parse(localStorage.getItem('dataLogs_stkmove')) || [];

                    updateLogs(dataList)

                    function fix_key(key) { return key.replace(/^send_/, '_'); }

                    let test = removeEmptyField(data)

                    function trying(json) {
                        var keys = Object.keys(json);
                        var result = {};

                        for (i = 0; i < keys.length; i++) {
                            var key = keys[i];
                            result[fix_key(key)] = json[key];
                        }
                        return result;
                    }

                    let postdata = {
                        "no": dataList.length + 1,
                        "data": trying(test)
                    }
                    console.log("POSTDATA：", postdata)
                    console.log("DATALIST：", dataList)
                    dataList.push(postdata)
                    console.log(typeof dataList)
                    localStorage.setItem('dataLogs_stkmove', JSON.stringify(dataList))
                    updateLogs(dataList)

                    postdata = ''
                    idRefresh()

                    //console.log(data.length)
                    //console.log(data.send_xml)
                    //var txt2 = $("").text(data.replay);
                    //console.log(txt2)
                    //$("body").append(txt2)
                    //alert(data.validate)
                    //alert(data.Rtnfood)
                    //也可以用jquery來呈現結果
                    //food_name = data.Rtnfood
                    //console.log("食物1:" + food_name)
                },
                contentType: false,
                processData: false,
                dataType: "json",
            });
            function show() {
                var mydate = new Date();

                var mytime = mydate.toLocaleTimeString(); //獲取當前時間
                time = mydate.toLocaleString();//獲取日期與時間
                //console.log("開始時間" + time);
                //console.log("receive message");
                var recv_data = new FormData();
                //recv_data.append('strCOMMANDID', $("#strCOMMANDID").val())
                $.ajax({
                    type: "POST",
                    url: $SCRIPT_ROOT + "/receive_function",
                    data: recv_data,
                    success: (data) => {
                        if (data.length > 0) {
                            //console.log("大於0")
                            var json_recv = [data[0], data[1]];
                        }
                        else {
                            //console.log("小於0")
                            var json_recv = [data];
                        }

                        for (var i = 0, l = json_recv.length; i < l; i++) {
                            for (var key in json_recv[i]) {
                                if (json_recv[i][key] !== "msmq no message") {
                                    if (json_recv[i][key] !== "msmq no label") {
                                        console.log(key + ':' + json_recv[i][key]);
                                    }

                                }

                            }
                        }
                        //console.log("驗證:" + data.validate);
                        //console.log("價錢:" + data.PayAmount);
                        //console.log(data.message_label)

                        // const input = data.recv_message_label
                        // displayData(input)
                        if (data.recv_message_label != 'msmq no label') {
                            let dataList = JSON.parse(localStorage.getItem('dataLogs_stkmove')) || []

                            updateLogs(dataList)

                            let test = removeEmptyField(data)
                            console.log("TESTDATA", test)

                            function fix_key_recv(key) { return key.replace(/^recv_/, '_'); }
                            function fix_key_send(key) { return key.replace(/^send_/, '_'); }

                            function tryingrecv(json) {
                                var keys = Object.keys(json);
                                var result = {};

                                for (i = 0; i < keys.length; i++) {
                                    var key = keys[i];
                                    result[fix_key_recv(key)] = json[key];
                                }
                                return result;
                            }

                            function tryingsend(json) {
                                var keys = Object.keys(json);
                                var result = {};

                                for (i = 0; i < keys.length; i++) {
                                    var key = keys[i];
                                    result[fix_key_send(key)] = json[key];
                                }
                                return result;
                            }
                            console.log("TESTLENGTH", test.length)
                            if (test.length === undefined) {
                                console.log("TESTUNDEFINED", test)
                                let resdata = {
                                    "no": dataList.length + 1,
                                    "data": tryingrecv(test)
                                }
                                // console.log("RESDATA：", resdata)
                                dataList.push(resdata)
                                console.log(typeof dataList)
                                localStorage.setItem('dataLogs_stkmove', JSON.stringify(dataList))
                                updateLogs(dataList)

                                resdata = ''
                            } else if (test.length == 2) {
                                console.log("TEST2", test)
                                let resRecv = test.find(o => o['recv_FUNCTION'])
                                let resSend = test.find(o => o['send_FUNCTION'])

                                let resRecvdata = {
                                    "no": dataList.length + 1,
                                    "data": tryingrecv(resRecv)
                                }
                                dataList.push(resRecvdata)
                                console.log(typeof dataList)
                                localStorage.setItem('dataLogs_stkmove', JSON.stringify(dataList))
                                updateLogs(dataList)
                                resRecvdata = ''

                                let resSenddata = {
                                    "no": dataList.length + 1,
                                    "data": tryingsend(resSend)
                                }
                                dataList.push(resSenddata)
                                console.log(typeof dataList)
                                localStorage.setItem('dataLogs_stkmove', JSON.stringify(dataList))
                                updateLogs(dataList)
                                resSenddata = ''

                            }

                        }

                    },
                    contentType: false,
                    processData: false,
                    dataType: "json"
                });
                //console.log("結束時間" + time);
            }
            setInterval(show, 3000);// 注意函式名沒有引號和括弧！
            // 使用setInterval(“show()”,3000);會報“缺少物件”


        }

    );

    function removeEmptyField(obj) {
        var newObj = {}
        if (typeof obj === 'string') {
            obj = JSON.parse(obj)
        }
        if (obj instanceof Array) {
            newObj = []
        }
        if (obj instanceof Object) {
            for (var attr in obj) {
                // 属性值不为'',null,undefined才加入新对象里面(去掉'',null,undefined)
                if (obj.hasOwnProperty(attr) && obj[attr] !== '' && obj[attr] !== null && obj[attr] !== undefined) {
                    if (obj[attr] instanceof Object) {
                        // 空数组或空对象不加入新对象(去掉[],{})
                        if (JSON.stringify(obj[attr]) === '{}' || JSON.stringify(obj[attr]) === '[]') {
                            continue
                        }
                        // 属性值为对象,则递归执行去除方法
                        newObj[attr] = removeEmptyField(obj[attr])
                    } else if (
                        typeof obj[attr] === 'string' &&
                        ((obj[attr].indexOf('{') > -1 && obj[attr].indexOf('}') > -1) ||
                            (obj[attr].indexOf('[') > -1 && obj[attr].indexOf(']') > -1))
                    ) {
                        // 属性值为JSON时
                        try {
                            var attrObj = JSON.parse(obj[attr])
                            if (attrObj instanceof Object) {
                                newObj[attr] = removeEmptyField(attrObj)
                            }
                        } catch (e) {
                            newObj[attr] = obj[attr]
                        }
                    } else {
                        newObj[attr] = obj[attr]
                    }
                }
            }
        }
        return newObj
    }

    function cleanup() {
        localStorage.removeItem('dataLogs_stkmove')

        let datatables = document.querySelector('#datatables')

        let dataList = JSON.parse(localStorage.getItem('dataLogs_stkmove')) || []
        let logstable = $("#datatables-reponsive").DataTable()
        logstable.clear()
        logstable.rows.add(dataList).draw()
    }



    $(() => {
        $('#strFROMDEVICE_selected').change(() => {
            $("#strCARRIERRID").val(($('#strFROMDEVICE_selected').val()) + "-" + ($('#strFROMPORT_selected').val()));

        });
    });
    $(() => {
        $('#strFROMPORT_selected').change(() => {
            $("#strCARRIERRID").val(($('#strFROMDEVICE_selected').val()) + "-" + ($('#strFROMPORT_selected').val()));

        });
    });


    function PrefixInteger(num, length) {
        return (Array(length).join('0') + num).slice(-length);
    }

    $(function () {
        $('form').bind('submit', function () { //给form标签绑定submit事件

            var i = 0;

            $("input").each(function () { //遍历input标签，判断是否有内容未填写

                var vl = $(this).val();

                if (vl == "") {
                    i = 1;

                }

            });

            if (i == 1) { //如果有未填写的，则return false阻止提交

                alert('請填寫');

                return false;

            }

        });

    });

</script>
{% endblock %}