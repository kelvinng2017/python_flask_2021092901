{% extends 'header.html' %}

{% block head %}
<title>Transfer Test - Gyro Test Tools</title>
<link rel="stylesheet" type="text/css" href="../static/css/dashborad.css">
<link href="{{ url_for('static', filename='css/bootstrap-table.min.css') }}" rel="stylesheet">
<script src="{{ url_for('static', filename='js/bootstrap-table.min.js') }}" type="text/javascript"></script>
<script src="{{ url_for('static', filename='js/dist_shim.min.js') }}" type="text/javascript"></script>
<script src="{{ url_for('static', filename='js/dist_xlsx.full.min.js') }}" type="text/javascript"></script>
{% endblock %}

{% block body %}
<div class="row mb-3 d-flex justify-content-between">
    <div class="col-10">
        <h1 class="h4 mb-0 align-bottom">Function Name: {{stk_dict["strFunction"]}}</h1>
    </div>
    <div class="col-2 text-end">
        <button class="btn btn-primary" onclick="location.reload()">Refresh</button>
    </div>
</div>
<div class="row">
<!-- LOGS TABLE START -->
    <div class="col-10">
        <!-- EXCEL LAUNCH START -->
        <div id="excelTable" class="card d-none">
            <div class="card-header pb-0">
                <div class="row">
                    <h2 class="h3 col-10">EXCEL ROWS</h2>
                    <div class="col-2 text-end">
                        <button type="button" class="btn btn-primary" onclick="closeExcel()">
                            Close
                        </button>
                    </div>
                </div>
            </div>
            <div class="card-body">
                <table
                id="excelFile"
                data-pagination="true"
                data-id-field="id"
                data-page-list="[10, 25, 50, 100, all]"
                >
                    <thead>
                        <tr>
                            <th data-field="strCARRIERTYPE">strCARRIERTYPE</th>
                            <th data-field="strCOMMANDID">strCOMMANDID</th>
                            <th data-field="strUSERID">strUSERID</th>
                            <th data-field="strCARRIERID">strCARRIERID</th>
                            <th data-field="strFROMDEVICE">strFROMDEVICE</th>
                            <th data-field="strFROMPORT">strFROMPORT</th>
                            <th data-field="strTODEVICE">strTODEVICE</th>
                            <th data-field="strTOPORT">strTOPORT</th>
                            <th data-field="strEMPTYCARRIER">strEMPTYCARRIER</th>
                            <th data-field="strPRIORITY">strPRIORITY</th>
                            <th data-field="strCMD">strCMD</th>
                            <th data-field="strMETHODNAME">strMETHODNAME</th>
                            <th data-field="strFORMNAME">strFORMNAME</th>
                            <th data-field="delay">delay</th>
                        </tr>
                    </thead>
                </table>
            </div>
        </div>
        <!-- EXCEL LAUNCH END -->
        <div class="card">
            <div class="card-header pb-0">
                <div class="row">
                    <h2 class="h3 col-10">Logs</h2>
                    <div class="col-2 text-end">
                        <button type="button" class="btn btn-primary" onclick="cleanup()">
                            Clear Logs
                        </button>
                    </div>
                </div>
            </div>
            <div class="card-body pt-0">
                <table 
                id="table" 
                data-toolbar="#toolbar" 
                data-search="true" 
                data-show-toggle="true"
                data-show-fullscreen="true" 
                data-show-pagination-switch="true" 
                data-pagination="true"
                data-id-field="id" 
                data-page-list="[10, 25, 50, 100, all]"
                >
                </table>
            </div>
        </div>
    </div>
<!-- LOGS TABLE END -->
<!-- CONTROL FORM START -->
    <div class="col-2">
        <div class="card">
            <div class="card-body py-3">
                <div class="row">
                    <div class="mb-2">
                        <label class="form-label fw-bolder">Batch Processing:</label>
                        <button id="batch" type="button" class="btn btn-primary w-100 mt-2">Batch</button>
                        <!-- <button type="button" class="btn btn-primary w-100 mt-2" onclick="xFile.click()">Launch Excel</button>
                        <input type="file" id="xFile" style="display: none" name="" accept="application/vnd.ms-excel,application/vnd.openxmlformats-officedocument.spreadsheetml.sheet" onchange="showfile(this)"> -->
                    </div>
                </div>
            </div>
        </div>
        <div class="card">
            <div class="card-body py-3">
                <div class="row">
                    <label class="form-label fw-bolder">Input:</label>
                    <div class="mb-2">
                        <label class="form-label" for="strCOMMANDID">strCOMMANDID:</label>
                        <input class="form-control" type="text" id="strCOMMANDID" name="strCOMMANDID" value={{stk_dict["strCOMAND"]}}>
                    </div>
                    <div class="mb-2">
                        <label class="form-label" for="strUSERID">strUSERID:</label>
                        <input class="form-control" type="text" id="strUSERID" name="strUSERID" value={{stk_dict["strUSERID"]}}>
                    </div>
                    <div class="mb-2">
                        <label class="form-label" for="strCARRIERID">strCARRIERID:</label>
                        <select class="form-select" type="submit" name="strCARRIERRID" id="strCARRIERRID_selected">
                            <option value="{{stk_dict['strCARRIERRID'][0]}}" selected>{{stk_dict["strCARRIERRID"][0]}}</option>
                            {% for strCARRIERRID in stk_dict["strCARRIERRID"][1:] %}
                            <option value="{{strCARRIERRID}}" id="hope_id">{{strCARRIERRID}}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-2">
                        <label class="form-label" for="strCARRIERTYPE">strCARRIERTYPE:</label>
                        <input class="form-control" type="text" id="strCARRIERTYPE" name="strCARRIERTYPE" value="MAGAZINE">
                    </div>
                    <div class="mb-2">
                        <label class="form-label" for="strFROMDEVICE">strFROMDEVICE:</label>
                        <select class="form-select" type="submit" name="strFROMDEVICE" id="strFROMDEVICE_selected">
                            <option value="{{stk_dict['strFROMDEVICE'][0]}}" selected>{{stk_dict["strFROMDEVICE"][0]}}</option>
                            {% for strTODEVICE in stk_dict["strFROMDEVICE"][1:] %}
                            <option value="{{strFROMDEVICE}}" id="hope_id">{{strFROMDEVICE}}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-2">
                        <label class="form-label" for="strFROMPORT">strFROMPORT:</label>
                        <input class="form-control" type="text" id="strFROMPORT" name="strFROMPORT" value="1234">
                    </div>
                    <div class="mb-2">
                        <label class="form-label" for="strTODEVICE">strTODEVICE:</label>
                        <input class="form-control" type="text" id="strTODEVICE" name="strTODEVICE" value="ER-A01">
                    </div>
                    <div class="mb-2">
                        <label class="form-label" for="strT0PORT">strTOPORT:</label>
                        <input class="form-control" type="text" id="strTOPORT" name="strTOPORT" value="02">
                    </div>
                    <div class="mb-2">
                        <label class="form-label" for="strPRIORITY">strPRIORITY:</label>
                        <input class="form-control" type="text" id="strPRIORITY" name="strPRIORITY" value="1">
                    </div>
                    <div class="mb-2">
                        <label class="form-label" for="strMETHODNAME">strMETHODNAME:</label>
                        <input class="form-control" type="text" id="strMETHODNAME" name="strMETHODNAME" value={{stk_dict["strFunction"]}}>
                    </div>
                    <div class="mb-2">
                        <label class="form-label" for="strFORMNAME">strFORMNAME:</label>
                        <input class="form-control" type="text" id="strFORMNAME" name="strFORMNAME" value={{stk_dict["strFORNAME"]}}>
                    </div>
                    <div class="mb-2">
                        <label class="form-label" for="strCMD">strCMD:</label>
                        <input class="form-control" type="text" id="strCMD" name="strCMD" value={{stk_dict["strFunction"]}}>
                    </div>
                    <div class="mb-2">
                        <label class="form-label" class="form-label" for="" form-label>　</label>
                        <button id="send_to_ACS_Getway" type="button" class="btn btn-primary w-100">send_to_ACS_Getway</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
<!-- CONTROL FORM END -->
</div>


    <script type=text/javascript>
    let $table = $('#table')
    let $batchTable = $('#excelFile')
    let logsData = JSON.parse(localStorage.getItem('dataLogs_moverequest')) || []

    function batchTable(data){
        // console.log("TABLE", data)
        $batchTable.bootstrapTable('destroy').bootstrapTable({data: data})
        $('#excelTable').removeClass('d-none')
        data = ''
    }

    function closeExcel(){
        $('#excelTable').addClass('d-none')
    }
    
    function initTable() {
        $table.bootstrapTable('destroy').bootstrapTable({
            data: logsData,
            columns: [
                {
                    field: 'no',
                    title: 'No.',
                    align: 'center',
                    valign: 'middle'
                }, {
                    field: 'data._FUNCTION',
                    title: 'Function',
                    align: 'center',
                    valign: 'middle'
                }, {
                    field: 'data._strCOMMANDID',
                    title: 'COMMANDID',
                    align: 'center',
                    valign: 'middle',
                    sortable: true
                },
                {
                    field: 'data._strCARRIERID',
                    title: 'CARRIERID',
                    align: 'center',
                    valign: 'middle'
                }, {
                    field: 'data._strFROMDEVICE',
                    title: 'FROMDEVICE/STKID',
                    align: 'center',
                    valign: 'middle'
                }, {
                    field: 'data._strFROMPORT',
                    title: 'FROMPORT',
                    align: 'center',
                    valign: 'middle'
                }, {
                    field: 'data._strFROMDEVICE',
                    title: 'FROMDEVICE/STKID',
                    align: 'center',
                    valign: 'middle'
                }, {
                    field: 'data._strTODEVICE',
                    title: 'TODEVICE',
                    align: 'center',
                    valign: 'middle'
                }, {
                    field: 'data._strTOPORT',
                    title: 'TOPORT',
                    align: 'center',
                    valign: 'middle'
                }, {
                    field: 'data._strRESULT',
                    title: 'RESULT',
                    align: 'center',
                    valign: 'middle'
                }, {
                    title: 'Details',
                    valign: 'middle',
                    formatter: detailFormatter
                }
            ]
        })
    }

    $(function () {
        initTable()
    })

    // 讀取文件內容
    let excelFile =''
    // 讀取文件內容
    function showfile(obj) {
        if(!obj.files) {
            return
        }
        let f = obj.files[0]
        let reader = new FileReader()
        reader.readAsBinaryString(f)
        reader.onload = function(e) {
            let data = e.target.result
            // console.log("DATA", data)
            excelFile = XLSX.read(data, {
                type: 'binary'
            })
            // console.log("EXCELPATH2", excelFile)

            //展示所有表
            // for(let i=0;i<excelFile.SheetNames.length;i++){
            // 	　document.getElementById("excelFile").innerHTML +=excelFile.SheetNames[i]+"="+JSON.stringify(XLSX.utils.sheet_to_json(excelFile.Sheets[excelFile.SheetNames[i]]))+"<br/>";
            // 　　　　　　}

            let dataTable1 = ""
            //只展示第一個表
            let headers = new Array();
            let str = XLSX.utils.sheet_to_json(excelFile.Sheets[excelFile.SheetNames[0]])
            // console.log("長度", str)
            // dataTable1+= "<div class='collapse show' id='multiCollapseExample1'><div class='card card-body'><div class='table-responsive'><table class='table table-striped table-lg '><tr>"
            // for(let key in str[0]){
            //     headers.push(key)  //獲取表頭
            //     dataTable1 += "<th>" + key + "</th>"
            // }
            // dataTable1 += "</tr>"
            // console.log(headers)
            //顯示行數
            // for(let i = 0; i < str.length ; i++){
                // let json = JSON.stringify(str[i])
            //     dataTable1 += "<tr>"
            //     let json = str[i]
            //     for( let j=0;j<headers.length;j++){
            //         dataTable1 += "<td>" + json[headers[j]] + "</td>";
            //     }
            //     dataTable1 += "</tr>";
            // }

            // dataTable1 += "</table></div></div></div>"
            batchTable(str)

            obj.value = ''
        }
        excelFile =''
    }

    function detailFormatter(value, row, index) {
        let str = ''

        str += '<button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#a' + row.data._strCOMMANDID + '">Details</button><div class="modal fade" id="a' + row.data._strCOMMANDID + '" tabindex="-1" aria-labelledby="label_' + row.data._strCOMMANDID + '" aria-hidden="true"><div class="modal-dialog modal-lg modal-dialog-centered"><div class="modal-content"><div class="modal-header"><h5 class="modal-title fs-3">Details</h5><button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button></div><div class="modal-body">'
        str += '<table class="table table-striped table-sm"><thead><tr><th scope="col">#</th><th scope="col">Key</th><th scope="col">Result</th></tr></thead><tbody>',
            Object.keys(row.data).forEach((key, index) => {
                str += '<tr>'
                str += `<td>${index + 1}</td>`
                str += `<td>${key}</td>`
                if (key == '_message_body') {
                    str += `<td><xmp class="text-wrap">${row.data[key]}</xmp></td>`
                } else {
                    str += `<td>${row.data[key]}</td>`
                }

                str += '</tr>'
            })
        str += '</tbody></table></div></div></div></div>'
        return str
    }


    function update() {
        let newData = JSON.parse(localStorage.getItem('dataLogs_moverequest')) || []
        $table.bootstrapTable('load', newData)
    }

        $SCRIPT_ROOT = {{ request.script_root|tojson|safe }};
        idRefresh()

        let dataList = JSON.parse(localStorage.getItem('dataLogs_moverequest')) || [];

        update()

        $('#send_to_ACS_Getway').click(
            function () {
                console.log("function is send");
                var form_data = new FormData();
                form_data.append('strCOMMANDID', $("#strCOMMANDID").val());
                form_data.append('strUSERID', $("#strUSERID").val());
                form_data.append('strCARRIERRID', $("#strCARRIERRID_selected").val());
                form_data.append('strCARRIERTYPE', $("#strCARRIERTYPE").val());
                form_data.append('strFROMDEVICE', $("#strFROMDEVICE_selected").val());
                form_data.append('strFROMPORT', $("#strFROMPORT").val());
                form_data.append('strTODEVICE', $("#strTODEVICE").val());
                form_data.append('strTOPORT', $("#strTOPORT").val());
                form_data.append('strPRIORITY', $("#strPRIORITY").val());
                form_data.append('strMETHODNAME', $("#strMETHODNAME").val());
                form_data.append('strFORMNAME', $("#strFORMNAME").val());
                form_data.append('strCMD', $("#strCMD").val());
                // form_data.append('xxx', $("#xxx").text());
                //附帶text也是可以的
                //var food_name = "";
                //var food_price = "";
                $.ajax({
                    type: "POST",
                    url: $SCRIPT_ROOT + "/send_function",
                    data: form_data,
                    success: (data) => {
                        if (data.length > 0) {
                            console.log("大於0")
                            var json_send = [data[0], data[1]];
                        }
                        else {
                            console.log("小於0")
                            var json_send = [data];
                        }

                        for (var i = 0, l = json_send.length; i < l; i++) {
                            for (var key in json_send[i]) {
                                console.log(key + ':' + json_send[i][key]);
                            }
                        }
                        //console.log("驗證:" + data.validate);
                        //console.log("價錢:" + data.PayAmount);
                        //console.log(data)
                        //console.log(data.length)
                        //console.log(data.send_xml)
                        //var txt2 = $("").text(data.replay);
                        //console.log(txt2)

                        let dataList = JSON.parse(localStorage.getItem('dataLogs_moverequest')) || [];

                        update()

                        function fix_key(key) { return key.replace(/^send_/, '_'); }
                        
                        let test = removeEmptyField(data)
                        
                        function trying(json) {
                            var keys = Object.keys(json);
                            var result = {};

                            for (i = 0; i < keys.length; i++) {
                                var key = keys[i];
                                result[fix_key(key)] = json[key];
                            }
                            return result;
                        }

                        let postdata = {
                            "no": dataList.length +1,
                            "data": trying(test)
                        }
                        console.log("POSTDATA：", postdata)
                        console.log("DATALIST：", dataList)
                        dataList.push(postdata)
                        console.log(typeof dataList)
                        localStorage.setItem('dataLogs_moverequest', JSON.stringify(dataList))
                        update()
                        
                        postdata = ''
                        idRefresh()
                        
                        //$("body").append(txt2)
                        //alert(data.validate)
                        //alert(data.Rtnfood)
                        //也可以用jquery來呈現結果
                        //food_name = data.Rtnfood
                        //console.log("食物1:" + food_name)
                    },
                    contentType: false,
                    processData: false,
                    dataType: "json"
                });
                function show() {
                    var mydate = new Date();

                    var mytime = mydate.toLocaleTimeString(); //獲取當前時間
                    time = mydate.toLocaleString();//獲取日期與時間
                    //console.log("開始時間" + time);
                    //console.log("receive message");
                    var recv_data = new FormData();
                    //recv_data.append('strCOMMANDID', $("#strCOMMANDID").val())
                    $.ajax({
                        type: "POST",
                        url: $SCRIPT_ROOT + "/receive_function",
                        data: recv_data,
                        success: (data) => {
                            if (data.length > 0) {
                                //console.log("大於0")
                                var json_recv = [data[0], data[1]];
                            }
                            else {
                                //console.log("小於0")
                                var json_recv = [data];
                            }

                            for (var i = 0, l = json_recv.length; i < l; i++) {
                                for (var key in json_recv[i]) {
                                    if (json_recv[i][key] !== "msmq no message") {
                                        if (json_recv[i][key] !== "msmq no label") {
                                            console.log(key + ':' + json_recv[i][key]);
                                        }

                                    }

                                }
                            }
                            //console.log("驗證:" + data.validate);
                            //console.log("價錢:" + data.PayAmount);
                            //console.log(data.message_label)
                            //console.log(data.message_body)
                            //var txt2 = $("").text(data.replay);
                            //console.log(txt2)
                            //$("body").append(txt2)
                            if ( data.recv_message_label != 'msmq no label') {
                                let dataList = JSON.parse(localStorage.getItem('dataLogs_moverequest')) || []

                                update() 
                                
                                let test = removeEmptyField(data)
                                console.log("TESTDATA", test)

                                function fix_key_recv(key) { return key.replace(/^recv_/, '_'); }
                                function fix_key_send(key) { return key.replace(/^send_/, '_'); }
                                
                                function tryingrecv(json) {
                                var keys = Object.keys(json);
                                var result = {};

                                for (i = 0; i < keys.length; i++) {
                                        var key = keys[i];
                                        result[fix_key_recv(key)] = json[key];
                                    }
                                    return result;
                                }
                                
                                function tryingsend(json) {
                                var keys = Object.keys(json);
                                var result = {};

                                for (i = 0; i < keys.length; i++) {
                                        var key = keys[i];
                                        result[fix_key_send(key)] = json[key];
                                    }
                                    return result;
                                }
                                console.log("TESTLENGTH", test.length)
                                if(test.length === undefined){
                                    console.log("TESTUNDEFINED", test)
                                    let resdata =  {
                                        "no": dataList.length +1,
                                        "data": tryingrecv(test)
                                    }
                                    // console.log("RESDATA：", resdata)
                                    dataList.push(resdata)
                                    console.log(typeof dataList)
                                    localStorage.setItem('dataLogs_moverequest', JSON.stringify(dataList))
                                    update()
                                    
                                    resdata = ''
                                }else if(test.length == 2) {
                                    console.log("TEST2", test)
                                    let resRecv =  test.find(o => o['recv_FUNCTION'])
                                    let resSend =  test.find(o => o['send_FUNCTION'])
                                    
                                    let resRecvdata =  {
                                        "no": dataList.length +1,
                                        "data": tryingrecv(resRecv)
                                    }
                                    dataList.push(resRecvdata)
                                    console.log(typeof dataList)
                                    localStorage.setItem('dataLogs_moverequest', JSON.stringify(dataList))
                                    update()
                                    resRecvdata = ''

                                    let resSenddata =  {
                                        "no": dataList.length +1,
                                        "data": tryingsend(resSend)
                                    }
                                    dataList.push(resSenddata)
                                    console.log(typeof dataList)
                                    localStorage.setItem('dataLogs_moverequest', JSON.stringify(dataList))
                                    update()
                                    resSenddata = ''

                                }
                                
                            }
                            //alert(data.validate)
                            //alert(data.Rtnfood)
                            //也可以用jquery來呈現結果
                            //food_name = data.Rtnfood
                            //console.log("食物1:" + food_name)
                        },
                        contentType: false,
                        processData: false,
                        dataType: "json"
                    });
                    //console.log("結束時間" + time);
                }
                setInterval(show, 3000);// 注意函式名沒有引號和括弧！
                // 使用setInterval(“show()”,3000);會報“缺少物件”


            }
        );

        function removeEmptyField(obj) {
            var newObj = {}
            if (typeof obj === 'string') {
                obj = JSON.parse(obj)
            }
            if (obj instanceof Array) {
                newObj = []
            }
            if (obj instanceof Object) {
                for (var attr in obj) {
                // 属性值不为'',null,undefined才加入新对象里面(去掉'',null,undefined)
                if (obj.hasOwnProperty(attr) && obj[attr] !== '' && obj[attr] !== null && obj[attr] !== undefined) {
                    if (obj[attr] instanceof Object) {
                    // 空数组或空对象不加入新对象(去掉[],{})
                    if(JSON.stringify(obj[attr]) === '{}' || JSON.stringify(obj[attr]) === '[]') {
                        continue
                    }
                    // 属性值为对象,则递归执行去除方法
                    newObj[attr] = removeEmptyField(obj[attr])
                    } else if (
                    typeof obj[attr] === 'string' &&
                    ((obj[attr].indexOf('{') > -1 && obj[attr].indexOf('}') > -1) ||
                        (obj[attr].indexOf('[') > -1 && obj[attr].indexOf(']') > -1))
                    ) {
                    // 属性值为JSON时
                    try {
                        var attrObj = JSON.parse(obj[attr])
                        if (attrObj instanceof Object) {
                        newObj[attr] = removeEmptyField(attrObj)
                        }
                    } catch (e) {
                        newObj[attr] = obj[attr]
                    }
                    } else {
                    newObj[attr] = obj[attr]
                    }
                }
                }
            }
            return newObj
        }

    function cleanup() {
        localStorage.removeItem('dataLogs_moverequest')
        let newData = JSON.parse(localStorage.getItem('dataLogs_moverequest')) || []
        $table.bootstrapTable('load', newData)
    }



        function PrefixInteger(num, length) {
            return (Array(length).join('0') + num).slice(-length);
        }

        //console.log($("select").val());
        //});

        //});
        //$("#strFROMDEVICE").val("hope");
        $(function () {
            $('form').bind('submit', function () { //给form标签绑定submit事件

                var i = 0;

                $("input").each(function () { //遍历input标签，判断是否有内容未填写

                    var vl = $(this).val();

                    if (vl == "") {
                        i = 1;

                    }

                });

                if (i == 1) { //如果有未填写的，则return false阻止提交

                    alert('請填寫');

                    return false;

                }

            });

        });
    </script>
    {% endblock %}