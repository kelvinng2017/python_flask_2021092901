{% extends 'header.html' %}

{% block head %}
<title>Transfer Test - Gyro Test Tools</title>
<link rel="stylesheet" type="text/css" href="../static/css/dashborad.css">
<script src="{{ url_for('static', filename='js/datatables.js') }}" type="text/javascript"></script>
{% endblock %}

{% block body %}
<div class="row mb-3 d-flex justify-content-between">
    <div class="col-10">
        <h1 class="h3">Transfer Test</h1>
    </div>
    <div class="col-2 text-end">
        <button class="btn btn-primary" onclick="location.reload()">Refresh</button>
    </div>
</div>
<div class="row">
    {% include 'transfer_button.html' %}
    <div class="col-10">


        <h1>function name:{{stk_dict["strFunction"]}}</h1>
        <label for="strCOMMANDID">strCOMMANDID:</label>
        <input type="text" id="strCOMMANDID" name="strCOMMANDID" value={{stk_dict["strCOMAND"]}}><br><br>
        <label for="strUSERID">strUSERID:</label>
        <input type="text" id="strUSERID" name="strUSERID" value={{stk_dict["strUSERID"]}}><br><br>
        <label for="strCARRIERID">strCARRIERID:</label>
        <select type="submit" name="strCARRIERRID" id="strCARRIERRID_selected">
            <option value="{{stk_dict['strCARRIERRID'][0]}}" selected>{{stk_dict["strCARRIERRID"][0]}}</option>
            {% for strCARRIERRID in stk_dict["strCARRIERRID"][1:] %}
            <option value="{{strCARRIERRID}}" id="hope_id">{{strCARRIERRID}}</option>
            {% endfor %}
        </select><br><br>



        <label for="strCARRIERTYPE">strCARRIERTYPE:</label>
        <input type="text" id="strCARRIERTYPE" name="strCARRIERTYPE" value="MAGAZINE"><br><br>
        <label for="strFROMDEVICE">strFROMDEVICE:</label>
        <select type="submit" name="strFROMDEVICE" id="strFROMDEVICE_selected">
            <option value="{{stk_dict['strFROMDEVICE'][0]}}" selected>{{stk_dict["strFROMDEVICE"][0]}}</option>
            {% for strTODEVICE in stk_dict["strFROMDEVICE"][1:] %}
            <option value="{{strFROMDEVICE}}" id="hope_id">{{strFROMDEVICE}}</option>
            {% endfor %}
        </select><br><br>
        <label for="strFROMPORT">strFROMPORT:</label>
        <input type="text" id="strFROMPORT" name="strFROMPORT" value="1234"><br><br>
        <label for="strTODEVICE">strTODEVICE:</label>
        <input type="text" id="strTODEVICE" name="strTODEVICE"><br><br>
        <label for="strT0PORT">strTOPORT:</label>
        <input type="text" id="strTOPORT" name="strTOPORT"><br><br>
        <label for="strEMPTYCARRIER">strEMPTYCARRIER:</label>
        <input type="text" id="strEMPTYCARRIER" name="strEMPTYCARRIER" value="ON"><br><br>
        <label for="strPRIORITY">strPRIORITY:</label>
        <input type="text" id="strPRIORITY" name="strPRIORITY" value="1"><br><br>
        <label for="strMETHODNAME">strMETHODNAME:</label>
        <input type="text" id="strMETHODNAME" name="strMETHODNAME" value={{stk_dict["strFunction"]}}><br><br>
        <label for="strFORMNAME">strFORMNAME:</label>
        <input type="text" id="strFORMNAME" name="strFORMNAME" value={{stk_dict["strFORNAME"]}}><br><br>
        <label for="strCMD">strCMD:</label>
        <input type="text" id="strCMD" name="strCMD" value={{stk_dict["strFunction"]}}><br><br>
        <button id="send_to_ACS_Getway" type="button">send_to_ACS_Getway</button>


        <!-- Logs -->

        <div class="container-fluid p-0">
            <div class="row">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header pb-0">
                            <h2 class="h3">Logs</h2>
                        </div>
                        <div class="card-body pt-0">
                            <table id="datatables-reponsive" class="table table-striped" style="width:100%">
                                <thead>
                                    <tr>
                                        <th class="col-1">No.</th>
                                        <th>Function</th>
                                        <th>Message</th>
                                        <th>CARRIERID</th>
                                        <th>COMMANDID</th>
                                        <th>FORNAME</th>
                                        <th>TIMESTAMP</th>
                                        <th>Details</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td>1</td>
                                        <td>STKMOVE</td>
                                        <td></td>
                                        <td></td>
                                        <td></td>
                                        <td></td>
                                        <td>2021/09/23 11:17:02</td>
                                        <td>
                                            <button type="button" class="btn btn-primary" data-bs-toggle="modal"
                                                data-bs-target="#centeredModalPrimary">
                                                Details
                                            </button>
                                            <div class="modal fade" id="centeredModalPrimary" tabindex="-1"
                                                role="dialog" aria-hidden="true">
                                                <div class="modal-dialog modal-dialog-centered" role="document">
                                                    <div class="modal-content">
                                                        <div class="modal-header">
                                                            <h5 class="modal-title fs-3">Details</h5>
                                                            <button type="button" class="btn-close"
                                                                data-bs-dismiss="modal" aria-label="Close"></button>
                                                        </div>
                                                        <div class="modal-body m-3">
                                                            <p class="mb-0 fs-6" id="datalogs">
                                                                STKMOVE:310 send_message_label:ARRIVE_R <br>
                                                                STKMOVE:310 send_strCMD:ARRIVE_R<br>
                                                                STKMOVE:310 send_strCOMMANDID:202109231117020002<br>
                                                                STKMOVE:310 send_strERRORMESSAGE:null<br>
                                                                STKMOVE:310 send_strFORNAME:ACS<br>
                                                                STKMOVE:310 send_strMETHODNAME:ARRIVE_R<br>
                                                                STKMOVE:310 send_strRESULT:OK<br>
                                                                STKMOVE:310 recv_CLASSNAME:Class Name<br>
                                                                STKMOVE:310 recv_CLIENT_HOSTNAME:DESKTOP-Q9FSIOF<br>
                                                                STKMOVE:310 recv_DLL_NAME:ACS<br>
                                                                STKMOVE:310 recv_FUNCTION:ARRIVE<br>
                                                                STKMOVE:310 recv_FUNCTION_VERSION:1.6<br>
                                                                STKMOVE:310 recv_IP:192.168.0.85<br>
                                                                STKMOVE:310 recv_LANG:zh-TW<br>
                                                                STKMOVE:310 recv_PROCESS_ID:00000000<br>
                                                                STKMOVE:310 recv_QUEUE_NAME:MESQUEUE<br>
                                                                STKMOVE:310 recv_SERVERNAME:DESKTOP-Q9FSIOF<br>
                                                                STKMOVE:310 recv_TIMESTAMP:2021/09/23 11:17:02
                                                            </p>
                                                            <hr>
                                                            <p class="mb-0 fs-6" id="redatalogs">
                                                                TEST
                                                            </p>
                                                        </div>
                                                        <div class="modal-footer">
                                                            <button type="button" class="btn btn-secondary"
                                                                data-bs-dismiss="modal">Close</button>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>



    <script type=text/javascript>
        $SCRIPT_ROOT = {{ request.script_root|tojson|safe }};
    </script>

    <script language="javascript" type="text/javascript">

        $('#receive_from_MES').click(
            function () {
                console.log("receive message");
                var recv_data = new FormData();
                recv_data.append('strCOMMANDID', $("#strCOMMANDID").val())
                $.ajax({
                    type: "POST",
                    url: $SCRIPT_ROOT + "/receive_function",
                    data: recv_data,
                    success: (data) => {
                        //console.log("驗證:" + data.validate);
                        //console.log("價錢:" + data.PayAmount);
                        console.log(data.msmq_label)
                        console.log(data.msmq_message)
                        //var txt2 = $("").text(data.replay);
                        //console.log(txt2)
                        //$("body").append(txt2)
                        //alert(data.validate)
                        //alert(data.Rtnfood)
                        //也可以用jquery來呈現結果
                        //food_name = data.Rtnfood
                        //console.log("食物1:" + food_name)
                    },
                    contentType: false,
                    processData: false,
                    dataType: "json"
                });
            }
        );
        $('#send_to_ACS_Getway').click(
            function () {
                console.log("function is send");
                var form_data = new FormData();
                form_data.append('strCOMMANDID', $("#strCOMMANDID").val());
                form_data.append('strUSERID', $("#strUSERID").val());
                form_data.append('strCARRIERRID', $("#strCARRIERRID_selected").val());
                form_data.append('strCARRIERTYPE', $("#strCARRIERTYPE").val());
                form_data.append('strFROMDEVICE', $("#strFROMDEVICE").val());
                form_data.append('strFROMPORT', $("#strFROMPORT").val());
                form_data.append('strTODEVICE', $("#strTODEVICE_selected").val());
                form_data.append('strTOPORT', $("#strTOPORT").val());
                form_data.append('strEMPTYCARRIER', $("#strEMPTYCARRIER").val());
                form_data.append('strPRIORITY', $("#strPRIORITY").val());
                form_data.append('strMETHODNAME', $("#strMETHODNAME").val());
                form_data.append('strFORMNAME', $("#strFORMNAME").val());
                form_data.append('strCMD', $("#strCMD").val());
                // form_data.append('xxx', $("#xxx").text());
                //附帶text也是可以的
                //var food_name = "";
                //var food_price = "";
                $.ajax({
                    type: "POST",
                    url: $SCRIPT_ROOT + "/send_function",
                    data: form_data,
                    success: (data) => {
                        if (data.length > 0) {
                            console.log("大於0")
                            var json_send = [data[0], data[1]];
                        }
                        else {
                            console.log("小於0")
                            var json_send = [data];
                        }

                        for (var i = 0, l = json_send.length; i < l; i++) {
                            for (var key in json_send[i]) {
                                console.log(key + ':' + json_send[i][key]);
                            }
                        }
                        //console.log("驗證:" + data.validate);
                        //console.log("價錢:" + data.PayAmount);
                        //console.log(data)
                        //console.log(data.length)
                        //console.log(data.send_xml)
                        //var txt2 = $("").text(data.replay);
                        //console.log(txt2)
                        //$("body").append(txt2)
                        //alert(data.validate)
                        //alert(data.Rtnfood)
                        //也可以用jquery來呈現結果
                        //food_name = data.Rtnfood
                        //console.log("食物1:" + food_name)
                    },
                    contentType: false,
                    processData: false,
                    dataType: "json"
                });
                function show() {
                    var mydate = new Date();

                    var mytime = mydate.toLocaleTimeString(); //獲取當前時間
                    time = mydate.toLocaleString();//獲取日期與時間
                    //console.log("開始時間" + time);
                    //console.log("receive message");
                    var recv_data = new FormData();
                    //recv_data.append('strCOMMANDID', $("#strCOMMANDID").val())
                    $.ajax({
                        type: "POST",
                        url: $SCRIPT_ROOT + "/receive_function",
                        data: recv_data,
                        success: (data) => {
                            if (data.length > 0) {
                                //console.log("大於0")
                                var json_recv = [data[0], data[1]];
                            }
                            else {
                                //console.log("小於0")
                                var json_recv = [data];
                            }

                            for (var i = 0, l = json_recv.length; i < l; i++) {
                                for (var key in json_recv[i]) {
                                    if (json_recv[i][key] !== "msmq no message") {
                                        if (json_recv[i][key] !== "msmq no label") {
                                            console.log(key + ':' + json_recv[i][key]);
                                        }

                                    }

                                }
                            }
                            //console.log("驗證:" + data.validate);
                            //console.log("價錢:" + data.PayAmount);
                            //console.log(data.message_label)
                            //console.log(data.message_body)
                            //var txt2 = $("").text(data.replay);
                            //console.log(txt2)
                            //$("body").append(txt2)
                            //alert(data.validate)
                            //alert(data.Rtnfood)
                            //也可以用jquery來呈現結果
                            //food_name = data.Rtnfood
                            //console.log("食物1:" + food_name)
                        },
                        contentType: false,
                        processData: false,
                        dataType: "json"
                    });
                    //console.log("結束時間" + time);
                }
                setInterval(show, 3000);// 注意函式名沒有引號和括弧！
                // 使用setInterval(“show()”,3000);會報“缺少物件”


            }
        );




        $(() => {
            $('#strFROMDEVICE_selected').change(() => {
                // console.log('change');
                // console.log($('#cont select option:selected').text());
                console.log($('#strFROMDEVICE_selected').val());
            });
        });
        console.log("hpe");
        var selected_first_item = $("#strCARRIERRID_selected :selected").text();
        console.log("selected_first_item=" + selected_first_item)
        var selected_first_item_arr = selected_first_item.split('_')
        var selected_first_iten_arr1_split_stock = selected_first_item_arr[1].split("stock")
        console.log(selected_first_item_arr[0])
        console.log(selected_first_iten_arr1_split_stock[1])
        port_with_need = PrefixInteger(selected_first_iten_arr1_split_stock[1], 3)
        console.log(port_with_need)
        $("#strTODEVICE").val(selected_first_item_arr[0]);
        $("#strTOPORT").val(port_with_need);
        //$(() => {
        //$('#cont select').change(() => {
        // console.log('change');
        // console.log($('#cont select option:selected').text());
        $("#strCARRIERRID_selected").click(function () {
            var txt = $("#strCARRIERRID_selected :selected").text();
            console.log('change');
            console.log(txt);
            var txt_split = txt.split('_')
            console.log(txt_split[1])
            var txt_arr1_split = txt_split[1].split("stock")
            var txt_port = PrefixInteger(txt_arr1_split[1], 3)
            console.log(txt_arr1_split)
            $("#strTODEVICE").val(txt_split[0]);
            $("#strTOPORT").val(txt_port);



        });

        function PrefixInteger(num, length) {
            return (Array(length).join('0') + num).slice(-length);
        }

        //console.log($("select").val());
        //});

        //});
        //$("#strFROMDEVICE").val("hope");
        $(function () {
            $('form').bind('submit', function () { //给form标签绑定submit事件

                var i = 0;

                $("input").each(function () { //遍历input标签，判断是否有内容未填写

                    var vl = $(this).val();

                    if (vl == "") {
                        i = 1;

                    }

                });

                if (i == 1) { //如果有未填写的，则return false阻止提交

                    alert('請填寫');

                    return false;

                }

            });

        });


        $(function () {
            // body...
            $("#btn").click(function () {
                $.ajax({
                    url: "test_post/nn",
                    type: "POST",
                    dataType: "json",
                    success: function (data) {
                        // alert(data.name + ":" + data.age);
                        //$("#NAME2").val(data.name);
                        //$("#AGE2").val(data.age);
                        console.log(data)
                    }

                })
            })
        })







    </script>
    {% endblock %}