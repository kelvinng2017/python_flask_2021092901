{% extends 'header.html' %}

{% block head %}
<title>Transfer Test - Gyro Test Tools</title>
<link rel="stylesheet" type="text/css" href="../static/css/dashborad.css">
<link href="{{ url_for('static', filename='css/bootstrap-table.min.css') }}" rel="stylesheet">
<script src="{{ url_for('static', filename='js/bootstrap-table.min.js') }}" type="text/javascript"></script>
<script src="{{ url_for('static', filename='js/dist_shim.min.js') }}" type="text/javascript"></script>
<script src="{{ url_for('static', filename='js/dist_xlsx.full.min.js') }}" type="text/javascript"></script>
{% endblock %}

{% block body %}
<div class="row mb-3 d-flex justify-content-between">
    <div class="col-10">
        <h1 class="h4 mb-0 align-bottom">Function Name: {{stk_dict["strFunction"]}}</h1>
    </div>
    <div class="col-2 text-end">
        <button class="btn btn-primary" onclick="location.reload()">Refresh</button>
    </div>
</div>
<div class="row">
    <!-- LOGS TABLE START -->
    <div class="col-10">
        <div class="card">
            <div class="card-header pb-0">
                <div class="row">
                    <h2 class="h3 col-10">Logs</h2>
                    <div class="col-2 text-end">
                        <button type="button" class="btn btn-primary" onclick="cleanup()">
                            Clear Logs
                        </button>
                    </div>
                </div>
            </div>
            <div class="card-body pt-0">
                <table id="table" data-toolbar="#toolbar" data-search="true" data-show-toggle="true"
                    data-show-fullscreen="true" data-show-pagination-switch="true" data-pagination="true"
                    data-id-field="id" data-page-list="[10, 25, 50, 100, all]">
                    <thead>
                        <tr>
                            <th class="col-1" data-field="no">No.</th>
                            <th data-field="data._FUNCTION">Function</th>
                            <th data-field="data._strCOMMANDID">COMMANDID</th>
                            <th data-field="data._strCARRIERID">CARRIERID</th>
                            <th data-field="data._strFROMDEVICE">FROMDEVICE/STKID</th>
                            <th data-field="data._strFROMPORT">FROMPORT</th>
                            <th data-field="data._strTODEVICE">TODEVICE</th>
                            <th data-field="data._strTOPORT">TOPORT</th>
                            <th data-field="data._strVEHICLEID">VEHICLEID</th>
                            <th data-field="data._strRESULT">RESULT</th>
                            <th data-field="">Details</th>
                        </tr>
                    </thead>
                </table>
            </div>
        </div>
    </div>
    <!-- LOGS TABLE END -->
    <!-- CONTROL FORM START -->
    <div class="col-2">
        <div class="card">
            <div class="card-body py-3">
                <div class="row">
                    <div class="mb-2">
                        <label class="form-label fw-bolder">Batch Processing:</label>
                        <button id="batch" type="button" class="btn btn-primary w-100 mt-2">Batch</button>
                        <button type="button" class="btn btn-primary w-100 mt-2" data-bs-toggle="modal"
                            data-bs-target="#excelDataList">LAUNCH EXCEL</button>
                    </div>
                </div>
            </div>
        </div>
        <div class="card">
            <div class="card-body py-3">
                <div class="row">
                    <div class="mb-2">
                        <label class="form-label fw-bolder">Input:</label>
                        <label class="form-label" for="strCARRIERTYPE">strCARRIERTYPE:</label>
                        <input type="text" id="strCARRIERTYPE" name="strCARRIERTYPE" class="form-control"
                            value="MAGAZINE">
                    </div>
                    <div class="mb-2">
                        <label class="form-label" for="strCOMMANDID">strCOMMANDID:</label>
                        <input type="text" id="strCOMMANDID" name="strCOMMANDID" class="form-control" value={{ commandid
                            }}>
                    </div>
                    <div class="mb-2">
                        <label class="form-label" for="strUSERID">strUSERID:</label>
                        <input type="text" id="strUSERID" name="strUSERID" class="form-control"
                            value={{stk_dict["strUSERID"]}}>
                    </div>
                    <div class="mb-2">
                        <label class="form-label" for="strCARRIERID">strCARRIERID:</label>
                        <input type="text" id="strCARRIERRID" name="strCARRIERRID" class="form-control"
                            value="ER-A01-01">
                    </div>
                    <div class="mb-2">
                        <label class="form-label" for="strFROMDEVICE">strFROMDEVICE:</label>
                        <select type="submit" name="strFROMDEVICE" id="strFROMDEVICE_selected" class="form-select">
                            <option value="{{stk_dict['strFROMDEVICE'][0]}}" selected>
                                {{stk_dict["strFROMDEVICE"][0]}}</option>
                            {% for strFROMDEVICE in stk_dict["strFROMDEVICE"][1:] %}
                            <option value="{{strFROMDEVICE}}" id="hope_id">{{strFROMDEVICE}}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-2">
                        <label class="form-label" for="strFROMPORT">strFROMPORT:</label>
                        <select type="submit" name="strFROMPORT" id="strFROMPORT_selected" class="form-select">
                            <option value="{{stk_dict['strFROMPORT'][0]}}" selected>
                                {{stk_dict["strFROMPORT"][0]}}</option>
                            {% for strFROMPORT in stk_dict["strFROMPORT"][1:] %}
                            <option value="{{strFROMPORT}}" id="hope_id">{{strFROMPORT}}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-2">
                        <label class="form-label" for="strTODEVICE">strTODEVICE:</label>
                        <select type="submit" name="strTODEVICE" id="strTODEVICE_selected" class="form-select">
                            <option value="{{stk_dict['strTODEVICE'][0]}}" selected>
                                {{stk_dict["strTODEVICE"][0]}}</option>
                            {% for strTODEVICE in stk_dict["strTODEVICE"][1:] %}
                            <option value="{{strTODEVICE}}" id="hope_id">{{strTODEVICE}}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-2">
                        <label class="form-label" for="strT0PORT">strTOPORT:</label>
                        <input type="text" id="strTOPORT" name="strTOPORT" class="form-control"
                            value={{stk_dict["strTOPORT"]}}>
                    </div>
                    <div class="mb-2">
                        <label class="form-label" for="strEMPTYCARRIER">strEMPTYCARRIER:</label>
                        <input type="text" id="strEMPTYCARRIER" name="strEMPTYCARRIER" class="form-control" value="ON">
                    </div>
                    <div class="mb-2">
                        <label class="form-label" for="strPRIORITY">strPRIORITY:</label>
                        <input type="text" id="strPRIORITY" name="strPRIORITY" class="form-control" value="1">
                    </div>
                    <div class="mb-2">
                        <label class="form-label" for="strCMD">strCMD:</label>
                        <input type="text" id="strCMD" name="strCMD" class="form-control"
                            value={{stk_dict["strFunction"]}}>
                    </div>
                    <div class="mb-2">
                        <label class="form-label" for="strMETHODNAME">strMETHODNAME:</label>
                        <input type="text" id="strMETHODNAME" name="strMETHODNAME" class="form-control"
                            value={{stk_dict["strFunction"]}}>
                    </div>
                    <div class="mb-2">
                        <label class="form-label" for="strFORMNAME">strFORMNAME:</label>
                        <input type="text" id="strFORMNAME" name="strFORMNAME" class="form-control"
                            value={{stk_dict["strFORNAME"]}}>
                    </div>
                    <div class="mb-2">
                        <label for="" form-label>　</label>
                        <button id="send_to_ACS_Getway" type="button"
                            class="btn btn-primary w-100">send_to_ACS_Getway</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- CONTROL FORM END -->
</div>
<!-- EXCEL MODAL START -->
<div class="row">
    <div class="modal fade" id="excelDataList" data-bs-keyboard="false" tabindex="-1"
        aria-labelledby="excelDataListLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="excelDataListLabel">STKMOVE EXCEL</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="container-fluid table-responsive">
                        <div id="excelFile"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- EXCEL MODAL END -->

<script>
    let $table = $('#table')
    let logsData = JSON.parse(localStorage.getItem('dataLogs_stkmove')) || []

    function initTable() {
        $table.bootstrapTable('destroy').bootstrapTable({
            data: logsData,
            columns: [
                {
                    field: 'no',
                    title: 'No.',
                    align: 'center',
                    valign: 'middle'
                }, {
                    field: 'data._FUNCTION',
                    title: 'Function',
                    align: 'center',
                    valign: 'middle'
                }, {
                    field: 'data._strCOMMANDID',
                    title: 'COMMANDID',
                    align: 'center',
                    valign: 'middle',
                    sortable: true
                },
                {
                    field: 'data._strCARRIERID',
                    title: 'CARRIERID',
                    align: 'center',
                    valign: 'middle'
                }, {
                    field: 'data._strFROMDEVICE',
                    title: 'FROMDEVICE/STKID',
                    align: 'center',
                    valign: 'middle'
                }, {
                    field: 'data._strFROMPORT',
                    title: 'FROMPORT',
                    align: 'center',
                    valign: 'middle'
                }, {
                    field: 'data._strFROMDEVICE',
                    title: 'FROMDEVICE/STKID',
                    align: 'center',
                    valign: 'middle'
                }, {
                    field: 'data._strTODEVICE',
                    title: 'TODEVICE',
                    align: 'center',
                    valign: 'middle'
                }, {
                    field: 'data._strTOPORT',
                    title: 'TOPORT',
                    align: 'center',
                    valign: 'middle'
                }, {
                    field: 'data._strRESULT',
                    title: 'RESULT',
                    align: 'center',
                    valign: 'middle'
                }, {
                    title: 'Details',
                    valign: 'middle',
                    formatter: detailFormatter
                }
            ]
        })
    }

    $(function () {
        initTable()
        showfile()
    })

    // 讀取文件內容
    function showfile() {
        fetch('../static/batch_excel/stkmove.xlsx', {
        }).then((res) => {
            // console.log('object res', res);
            return res.blob();
        }).then((blob) => {
            let reader = new FileReader();

            reader.readAsBinaryString(blob);

            reader.onload = function (e) {
                let excelFile = ''
                let data = e.target.result;
                // console.log("DATA", data)
                excelFile = XLSX.read(data, {
                    type: 'binary'
                });
                // console.log("EXCELPATH2", excelFile)

                //展示所有表
                // for(let i=0;i<excelFile.SheetNames.length;i++){
                // 	　document.getElementById("excelFile").innerHTML +=excelFile.SheetNames[i]+"="+JSON.stringify(XLSX.utils.sheet_to_json(excelFile.Sheets[excelFile.SheetNames[i]]))+"<br/>";
                // 　　　　　　}

                let dataTable1 = "";
                //只展示第一個表
                let headers = new Array();
                let str = XLSX.utils.sheet_to_json(excelFile.Sheets[excelFile.SheetNames[0]])
                // console.log("長度", str.length)
                dataTable1 += "<table class='table table-striped table-lg'><tr>"
                for (let key in str[0]) {
                    headers.push(key)  //獲取表頭
                    dataTable1 += "<th>" + key + "</th>"
                }
                dataTable1 += "</tr>"
                // console.log(headers)
                //顯示行數
                for (let i = 0; i < str.length; i++) {
                    // let json = JSON.stringify(str[i])
                    dataTable1 += "<tr>"
                    let json = str[i]
                    for (let j = 0; j < headers.length; j++) {
                        dataTable1 += "<td>" + json[headers[j]] + "</td>";
                    }
                    dataTable1 += "</tr>";
                }

                dataTable1 += "</table>"
                document.getElementById("excelFile").innerHTML = dataTable1
            }
        })
    }

    function detailFormatter(value, row, index) {
        let str = ''

        str += '<button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#a' + row.data._strCOMMANDID + '">Details</button><div class="modal fade" id="a' + row.data._strCOMMANDID + '" tabindex="-1" aria-labelledby="label_' + row.data._strCOMMANDID + '" aria-hidden="true"><div class="modal-dialog modal-lg modal-dialog-centered"><div class="modal-content"><div class="modal-header"><h5 class="modal-title fs-3">Details</h5><button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button></div><div class="modal-body">'
        str += '<table class="table table-striped table-sm"><thead><tr><th scope="col">#</th><th scope="col">Key</th><th scope="col">Result</th></tr></thead><tbody>',
            Object.keys(row.data).forEach((key, index) => {
                str += '<tr>'
                str += `<td>${index + 1}</td>`
                str += `<td>${key}</td>`
                if (key == '_message_body') {
                    str += `<td><xmp class="text-wrap">${row.data[key]}</xmp></td>`
                } else {
                    str += `<td>${row.data[key]}</td>`
                }

                str += '</tr>'
            })
        str += '</tbody></table></div></div></div></div>'
        return str
    }


    function update() {
        let newData = JSON.parse(localStorage.getItem('dataLogs_stkmove')) || []
        $table.bootstrapTable('load', newData)
    }

    $SCRIPT_ROOT = {{ request.script_root | tojson | safe }};
    idRefresh()
    //console.log("strFROMDEVICE:" + $('#strFROMDEVICE_selected').val());
    //console.log("strFROMPORT:" + $('#strFROMPORT_selected').val());

    $("#strCARRIERRID").val(($('#strFROMDEVICE_selected').val()) + "-" + ($('#strFROMPORT_selected').val()));

    let dataList = JSON.parse(localStorage.getItem('dataLogs_stkmove')) || [];



    $('#receive_from_MES').click(
        function () {
            console.log("receive message");
            var recv_data = new FormData();
            recv_data.append('strCOMMANDID', $("#strCOMMANDID").val())
            $.ajax({
                type: "POST",
                url: $SCRIPT_ROOT + "/receive_function",
                data: recv_data,
                success: (data) => {
                    //console.log("驗證:" + data.validate);
                    //console.log("價錢:" + data.PayAmount);
                    console.log(data.msmq_label)
                    console.log(data.msmq_message)
                    //var txt2 = $("").text(data.replay);
                    //console.log(txt2)
                    //$("body").append(txt2)
                    //alert(data.validate)
                    //alert(data.Rtnfood)
                    //也可以用jquery來呈現結果
                    //food_name = data.Rtnfood
                    //console.log("食物1:" + food_name)
                },
                contentType: false,
                processData: false,
                dataType: "json"
            });
        }
    );

    $('#batch').click(
        function () {
            console.log("function_batch_in_ajax_script");
            var form_data = new FormData();
            // form_data.append('strCOMMANDID', $("#strCOMMANDID").val());
            // form_data.append('strUSERID', $("#strUSERID").val());
            // form_data.append('strCARRIERRID', $("#strCARRIERRID").val());
            // form_data.append('strCARRIERTYPE', $("#strCARRIERTYPE").val());
            // form_data.append('strFROMDEVICE', $("#strFROMDEVICE_selected").val());
            // form_data.append('strFROMPORT', $("#strFROMPORT_selected").val());
            // form_data.append('strTODEVICE', $("#strTODEVICE_selected").val());
            // form_data.append('strTOPORT', $("#strTOPORT").val());
            // form_data.append('strEMPTYCARRIER', $("#strEMPTYCARRIER").val());
            // form_data.append('strPRIORITY', $("#strPRIORITY").val());
            // form_data.append('strMETHODNAME', $("#strMETHODNAME").val());
            // form_data.append('strFORMNAME', $("#strFORMNAME").val());
            // form_data.append('strCMD', $("#strCMD").val());

            $.ajax({
                type: "POST",
                url: $SCRIPT_ROOT + "/send_stkmove_batch_function",
                data: form_data,
                success: (data) => {
                    if (data.length > 0) {
                        console.log("大於0")
                        var json_send = [data[0], data[1]];
                    }
                    else {
                        console.log("小於0")
                        var json_send = [data];
                    }

                    for (var i = 0, l = json_send.length; i < l; i++) {
                        for (var key in json_send[i]) {
                            console.log(key + ':' + json_send[i][key]);
                        }
                    }
                    //console.log("驗證:" + data.validate);
                    //console.log("價錢:" + data.PayAmount);
                    // console.log('DATA:', data)

                    // const input = data.send_message_label

                    let dataList = JSON.parse(localStorage.getItem('dataLogs_stkmove')) || [];

                    update()

                    function fix_key(key) { return key.replace(/^send_/, '_'); }

                    let test = removeEmptyField(data)

                    function trying(json) {
                        var keys = Object.keys(json);
                        var result = {};

                        for (i = 0; i < keys.length; i++) {
                            var key = keys[i];
                            result[fix_key(key)] = json[key];
                        }
                        return result;
                    }

                    console.log("POSTDATAORI", test)


                    let resendlog = Object.entries(test).slice(0, -1)
                    console.log("BATCHLOG", resendlog)

                    for (let i = 0; i < resendlog.length; i++) {

                        let postdata = {
                            "no": dataList.length + 1,
                            "data": trying(resendlog[i][1])
                        }

                        dataList.push(postdata)
                        console.log(typeof dataList)
                        console.log("BATCH", dataList)
                        localStorage.setItem('dataLogs_stkmove', JSON.stringify(dataList))
                        update()
                        postdata = ''
                    }


                    idRefresh()

                    //console.log(data.length)
                    //console.log(data.send_xml)
                    //var txt2 = $("").text(data.replay);
                    //console.log(txt2)
                    //$("body").append(txt2)
                    //alert(data.validate)
                    //alert(data.Rtnfood)
                    //也可以用jquery來呈現結果
                    //food_name = data.Rtnfood
                    //console.log("食物1:" + food_name)
                },
                contentType: false,
                processData: false,
                dataType: "json",
            });
            function show() {
                var mydate = new Date();

                var mytime = mydate.toLocaleTimeString(); //獲取當前時間
                time = mydate.toLocaleString();//獲取日期與時間
                //console.log("開始時間" + time);
                //console.log("receive message");
                var recv_data = new FormData();
                //recv_data.append('strCOMMANDID', $("#strCOMMANDID").val())
                $.ajax({
                    type: "POST",
                    url: $SCRIPT_ROOT + "/receive_function",
                    data: recv_data,
                    success: (data) => {
                        if (data.length > 0) {
                            //console.log("大於0")
                            var json_recv = [data[0], data[1]];
                        }
                        else {
                            //console.log("小於0")
                            var json_recv = [data];
                        }

                        for (var i = 0, l = json_recv.length; i < l; i++) {
                            for (var key in json_recv[i]) {
                                if (json_recv[i][key] !== "msmq no message") {
                                    if (json_recv[i][key] !== "msmq no label") {
                                        console.log(key + ':' + json_recv[i][key]);
                                    }

                                }

                            }
                        }
                        //console.log("驗證:" + data.validate);
                        //console.log("價錢:" + data.PayAmount);
                        //console.log(data.message_label)

                        // const input = data.recv_message_label
                        // displayData(input)
                        if (data.recv_message_label != 'msmq no label') {
                            let dataList = JSON.parse(localStorage.getItem('dataLogs_stkmove')) || []

                            update()

                            let test = removeEmptyField(data)
                            console.log("TESTDATA", test)

                            function fix_key_recv(key) { return key.replace(/^recv_/, '_'); }
                            function fix_key_send(key) { return key.replace(/^send_/, '_'); }

                            function tryingrecv(json) {
                                var keys = Object.keys(json);
                                var result = {};

                                for (i = 0; i < keys.length; i++) {
                                    var key = keys[i];
                                    result[fix_key_recv(key)] = json[key];
                                }
                                return result;
                            }

                            function tryingsend(json) {
                                var keys = Object.keys(json);
                                var result = {};

                                for (i = 0; i < keys.length; i++) {
                                    var key = keys[i];
                                    result[fix_key_send(key)] = json[key];
                                }
                                return result;
                            }
                            console.log("TESTLENGTH", test.length)
                            if (test.length === undefined) {
                                console.log("TESTUNDEFINED", test)
                                let resdata = {
                                    "no": dataList.length + 1,
                                    "data": tryingrecv(test)
                                }
                                // console.log("RESDATA：", resdata)
                                dataList.push(resdata)
                                console.log(typeof dataList)
                                localStorage.setItem('dataLogs_stkmove', JSON.stringify(dataList))
                                update()

                                resdata = ''
                            } else if (test.length == 1) {
                                if (test[0].data.stkmove_batch_0 != '') {
                                    let resendlog = Object.entries(test[0].data)
                                    console.log("ELSEBATCH", resendlog)

                                    for (let i = 0; i < resendlog.length; i++) {
                                        console.log("FIN", resendlog[i][1])
                                        let resSend = resendlog.find(o => o['send_FUNCTION'])

                                        let resSenddata = {
                                            "no": dataList.length + 1,
                                            "data": tryingsend(resSend)
                                        }
                                        dataList.push(resSenddata)
                                        console.log(typeof dataList)
                                        localStorage.setItem('dataLogs_stkmove', JSON.stringify(dataList))
                                        update()
                                        resSenddata = ''
                                    }
                                }
                            } else if (test.length == 2) {
                                console.log("TEST2", test)
                                let resRecv = test.find(o => o['recv_FUNCTION'])
                                let resSend = test.find(o => o['send_FUNCTION'])
                                let resRecvdata = {
                                    "no": dataList.length + 1,
                                    "data": tryingrecv(resRecv)
                                }
                                dataList.push(resRecvdata)
                                console.log(typeof dataList)
                                localStorage.setItem('dataLogs_stkmove', JSON.stringify(dataList))
                                update()
                                resRecvdata = ''

                                let resSenddata = {
                                    "no": dataList.length + 1,
                                    "data": tryingsend(resSend)
                                }
                                dataList.push(resSenddata)
                                console.log(typeof dataList)
                                localStorage.setItem('dataLogs_stkmove', JSON.stringify(dataList))
                                update()
                                resSenddata = ''

                            }

                        }

                    },
                    contentType: false,
                    processData: false,
                    dataType: "json"
                });
                //console.log("結束時間" + time);
            }
            setInterval(show, 3000);// 注意函式名沒有引號和括弧！
            // 使用setInterval(“show()”,3000);會報“缺少物件”


        }

    );

    $('#send_to_ACS_Getway').click(

        function () {
            console.log("function is send");
            var form_data = new FormData();
            form_data.append('strCOMMANDID', $("#strCOMMANDID").val());
            form_data.append('strUSERID', $("#strUSERID").val());
            form_data.append('strCARRIERRID', $("#strCARRIERRID").val());
            form_data.append('strCARRIERTYPE', $("#strCARRIERTYPE").val());
            form_data.append('strFROMDEVICE', $("#strFROMDEVICE_selected").val());
            form_data.append('strFROMPORT', $("#strFROMPORT_selected").val());
            form_data.append('strTODEVICE', $("#strTODEVICE_selected").val());
            form_data.append('strTOPORT', $("#strTOPORT").val());
            form_data.append('strEMPTYCARRIER', $("#strEMPTYCARRIER").val());
            form_data.append('strPRIORITY', $("#strPRIORITY").val());
            form_data.append('strMETHODNAME', $("#strMETHODNAME").val());
            form_data.append('strFORMNAME', $("#strFORMNAME").val());
            form_data.append('strCMD', $("#strCMD").val());
            // form_data.append('xxx', $("#xxx").text());
            //附帶text也是可以的
            //var food_name = "";
            //var food_price = "";

            $.ajax({
                type: "POST",
                url: $SCRIPT_ROOT + "/send_function",
                data: form_data,
                success: (data) => {
                    if (data.length > 0) {
                        console.log("大於0")
                        var json_send = [data[0], data[1]];
                    }
                    else {
                        console.log("小於0")
                        var json_send = [data];
                    }

                    for (var i = 0, l = json_send.length; i < l; i++) {
                        for (var key in json_send[i]) {
                            console.log(key + ':' + json_send[i][key]);
                        }
                    }
                    //console.log("驗證:" + data.validate);
                    //console.log("價錢:" + data.PayAmount);
                    // console.log('DATA:', data)

                    // const input = data.send_message_label

                    let dataList = JSON.parse(localStorage.getItem('dataLogs_stkmove')) || [];

                    update()

                    function fix_key(key) { return key.replace(/^send_/, '_'); }

                    let test = removeEmptyField(data)

                    function trying(json) {
                        var keys = Object.keys(json);
                        var result = {};

                        for (i = 0; i < keys.length; i++) {
                            var key = keys[i];
                            result[fix_key(key)] = json[key];
                        }
                        return result;
                    }

                    let postdata = {
                        "no": dataList.length + 1,
                        "data": trying(test)
                    }
                    console.log("POSTDATA：", postdata)
                    console.log("DATALIST：", dataList)
                    dataList.push(postdata)
                    console.log(typeof dataList)
                    localStorage.setItem('dataLogs_stkmove', JSON.stringify(dataList))
                    update()

                    postdata = ''
                    idRefresh()

                    //console.log(data.length)
                    //console.log(data.send_xml)
                    //var txt2 = $("").text(data.replay);
                    //console.log(txt2)
                    //$("body").append(txt2)
                    //alert(data.validate)
                    //alert(data.Rtnfood)
                    //也可以用jquery來呈現結果
                    //food_name = data.Rtnfood
                    //console.log("食物1:" + food_name)
                },
                contentType: false,
                processData: false,
                dataType: "json",
            });
            function show() {
                var mydate = new Date();

                var mytime = mydate.toLocaleTimeString(); //獲取當前時間
                time = mydate.toLocaleString();//獲取日期與時間
                //console.log("開始時間" + time);
                //console.log("receive message");
                var recv_data = new FormData();
                //recv_data.append('strCOMMANDID', $("#strCOMMANDID").val())
                $.ajax({
                    type: "POST",
                    url: $SCRIPT_ROOT + "/receive_function",
                    data: recv_data,
                    success: (data) => {
                        if (data.length > 0) {
                            //console.log("大於0")
                            var json_recv = [data[0], data[1]];
                        }
                        else {
                            //console.log("小於0")
                            var json_recv = [data];
                        }

                        for (var i = 0, l = json_recv.length; i < l; i++) {
                            for (var key in json_recv[i]) {
                                if (json_recv[i][key] !== "msmq no message") {
                                    if (json_recv[i][key] !== "msmq no label") {
                                        console.log(key + ':' + json_recv[i][key]);
                                    }

                                }

                            }
                        }
                        //console.log("驗證:" + data.validate);
                        //console.log("價錢:" + data.PayAmount);
                        //console.log(data.message_label)

                        // const input = data.recv_message_label
                        // displayData(input)
                        if (data.recv_message_label != 'msmq no label') {
                            let dataList = JSON.parse(localStorage.getItem('dataLogs_stkmove')) || []

                            update()

                            let test = removeEmptyField(data)
                            console.log("TESTDATA", test)

                            function fix_key_recv(key) { return key.replace(/^recv_/, '_'); }
                            function fix_key_send(key) { return key.replace(/^send_/, '_'); }

                            function tryingrecv(json) {
                                var keys = Object.keys(json);
                                var result = {};

                                for (i = 0; i < keys.length; i++) {
                                    var key = keys[i];
                                    result[fix_key_recv(key)] = json[key];
                                }
                                return result;
                            }

                            function tryingsend(json) {
                                var keys = Object.keys(json);
                                var result = {};

                                for (i = 0; i < keys.length; i++) {
                                    var key = keys[i];
                                    result[fix_key_send(key)] = json[key];
                                }
                                return result;
                            }
                            console.log("TESTLENGTH", test.length)
                            if (test.length === undefined) {
                                console.log("TESTUNDEFINED", test)
                                let resdata = {
                                    "no": dataList.length + 1,
                                    "data": tryingrecv(test)
                                }
                                // console.log("RESDATA：", resdata)
                                dataList.push(resdata)
                                console.log(typeof dataList)
                                localStorage.setItem('dataLogs_stkmove', JSON.stringify(dataList))
                                update()

                                resdata = ''
                            } else if (test.length == 2) {
                                console.log("TEST2", test)
                                let resRecv = test.find(o => o['recv_FUNCTION'])
                                let resSend = test.find(o => o['send_FUNCTION'])

                                let resRecvdata = {
                                    "no": dataList.length + 1,
                                    "data": tryingrecv(resRecv)
                                }
                                dataList.push(resRecvdata)
                                console.log(typeof dataList)
                                localStorage.setItem('dataLogs_stkmove', JSON.stringify(dataList))
                                update()
                                resRecvdata = ''

                                let resSenddata = {
                                    "no": dataList.length + 1,
                                    "data": tryingsend(resSend)
                                }
                                dataList.push(resSenddata)
                                console.log(typeof dataList)
                                localStorage.setItem('dataLogs_stkmove', JSON.stringify(dataList))
                                update()
                                resSenddata = ''

                            }

                        }

                    },
                    contentType: false,
                    processData: false,
                    dataType: "json"
                });
                //console.log("結束時間" + time);
            }
            setInterval(show, 3000);// 注意函式名沒有引號和括弧！
            // 使用setInterval(“show()”,3000);會報“缺少物件”


        }

    );

    function removeEmptyField(obj) {
        var newObj = {}
        if (typeof obj === 'string') {
            obj = JSON.parse(obj)
        }
        if (obj instanceof Array) {
            newObj = []
        }
        if (obj instanceof Object) {
            for (var attr in obj) {
                // 属性值不为'',null,undefined才加入新对象里面(去掉'',null,undefined)
                if (obj.hasOwnProperty(attr) && obj[attr] !== '' && obj[attr] !== null && obj[attr] !== undefined) {
                    if (obj[attr] instanceof Object) {
                        // 空数组或空对象不加入新对象(去掉[],{})
                        if (JSON.stringify(obj[attr]) === '{}' || JSON.stringify(obj[attr]) === '[]') {
                            continue
                        }
                        // 属性值为对象,则递归执行去除方法
                        newObj[attr] = removeEmptyField(obj[attr])
                    } else if (
                        typeof obj[attr] === 'string' &&
                        ((obj[attr].indexOf('{') > -1 && obj[attr].indexOf('}') > -1) ||
                            (obj[attr].indexOf('[') > -1 && obj[attr].indexOf(']') > -1))
                    ) {
                        // 属性值为JSON时
                        try {
                            var attrObj = JSON.parse(obj[attr])
                            if (attrObj instanceof Object) {
                                newObj[attr] = removeEmptyField(attrObj)
                            }
                        } catch (e) {
                            newObj[attr] = obj[attr]
                        }
                    } else {
                        newObj[attr] = obj[attr]
                    }
                }
            }
        }
        return newObj
    }

    function cleanup() {
        localStorage.removeItem('dataLogs_stkmove')
        let newData = JSON.parse(localStorage.getItem('dataLogs_stkmove')) || []
        $table.bootstrapTable('load', newData)
    }



    $(() => {
        $('#strFROMDEVICE_selected').change(() => {
            $("#strCARRIERRID").val(($('#strFROMDEVICE_selected').val()) + "-" + ($('#strFROMPORT_selected').val()));

        });
    });
    $(() => {
        $('#strFROMPORT_selected').change(() => {
            $("#strCARRIERRID").val(($('#strFROMDEVICE_selected').val()) + "-" + ($('#strFROMPORT_selected').val()));

        });
    });


    function PrefixInteger(num, length) {
        return (Array(length).join('0') + num).slice(-length);
    }

    $(function () {
        $('form').bind('submit', function () { //给form标签绑定submit事件

            var i = 0;

            $("input").each(function () { //遍历input标签，判断是否有内容未填写

                var vl = $(this).val();

                if (vl == "") {
                    i = 1;

                }

            });

            if (i == 1) { //如果有未填写的，则return false阻止提交

                alert('請填寫');

                return false;

            }

        });

    });

</script>
{% endblock %}